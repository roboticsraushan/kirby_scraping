<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nolon Campaign</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* Remove default margin to maximize space */
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 8px;
            overflow: hidden;
            height: calc(100vh - 16px);
            display: flex;
            flex-direction: column;
        }
        
        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 0 10px 0;
            text-align: center;
            margin-bottom: 0;
            flex-shrink: 0;
        }
        
        .app-header h1 {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 300;
        }
        .container-fluid {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 8px !important;
        }
        .row {
            margin-left: 0;
            margin-right: 0;
            flex: 1;
            display: flex;
        }
        
        .upload-area {
            border: 2px dashed #e3f2fd;
            border-radius: 8px;
            padding: 3px;
            text-align: center;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            margin-bottom: 3px;
            max-width: 100%;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background: linear-gradient(135deg, #e8f4fd 0%, #f8f0ff 100%);
            transform: translateY(-2px);
        }
        
        .upload-area.dragover {
            border-color: #4caf50;
            background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
        }
        
        .section-card {
            border-radius: 8px;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 6px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .section-card:last-child {
            margin-bottom: 0;
        }
        .section-header {
            padding: 6px 10px;
            border-bottom: 1px solid #f0f0f0;
            font-weight: 600;
            font-size: 0.85rem;
            flex-shrink: 0;
        }
        .card-body {
            padding: 6px !important;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .upload-section {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        }
        
        .upload-section .section-header {
            background: linear-gradient(135deg, #2196f3 0%, #9c27b0 100%);
            color: white;
        }
        
        .template-section {
            background: linear-gradient(135deg, #fff3e0 0%, #fce4ec 100%);
        }
        
        .template-section .section-header {
            background: linear-gradient(135deg, #ff9800 0%, #e91e63 100%);
            color: white;
        }
        
        .control-section {
            background: linear-gradient(135deg, #e8f5e8 0%, #f3e5f5 100%);
        }
        
        .control-section .section-header {
            background: linear-gradient(135deg, #4caf50 0%, #9c27b0 100%);
            color: white;
        }
        
        .logs-section {
            background: linear-gradient(135deg, #fce4ec 0%, #e3f2fd 100%);
        }
        
        .logs-section .section-header {
            background: linear-gradient(135deg, #e91e63 0%, #2196f3 100%);
            color: white;
        }
        
        .progress-container {
            display: none;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 8px;
            margin-top: 8px;
            margin-bottom: 0;
        }
        
        .log-container {
            max-height: 60px;
            min-height: 30px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 8px;
            border: 1px solid #e0e0e0;
            font-size: 0.75rem;
            flex: 1;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            border-left: 4px solid;
        }
        
        .log-success { 
            background: linear-gradient(135deg, #d4edda 0%, #c8e6c9 100%);
            color: #155724;
            border-left-color: #4caf50;
        }
        
        .log-error { 
            background: linear-gradient(135deg, #f8d7da 0%, #ffcdd2 100%);
            color: #721c24;
            border-left-color: #f44336;
        }
        
        .log-warning { 
            background: linear-gradient(135deg, #fff3cd 0%, #fff9c4 100%);
            color: #856404;
            border-left-color: #ff9800;
        }
        
        .log-info { 
            background: linear-gradient(135deg, #d1ecf1 0%, #b3e5fc 100%);
            color: #0c5460;
            border-left-color: #2196f3;
        }
        
        .template-preview {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .contact-preview {
            max-height: 50px;
            min-height: 25px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 6px;
            padding: 6px;
            font-size: 0.75rem;
            flex: 1;
        }
        
        .btn-campaign {
            min-width: 120px;
            border-radius: 25px;
            font-weight: 600;
            padding: 10px 25px;
            transition: all 0.3s ease;
        }
        
        .btn-campaign:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .status-running { background: #4caf50; }
        .status-stopped { background: #f44336; }
        .status-idle { background: #9e9e9e; }
        
        .stats-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 3px;
            text-align: center;
            margin: 1px;
        }
        
        .stats-number {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .stats-label {
            font-size: 0.65rem;
            color: #666;
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .file-info-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 8px;
            margin-top: 8px;
            border: 1px solid #e0e0e0;
        }
        .form-label, label, .fw-bold {
            font-size: 0.8rem !important;
        }
        .form-control, .btn, textarea, input[type="text"] {
            font-size: 0.8rem !important;
            padding: 2px 4px !important;
            height: 24px !important;
        }
        textarea.form-control {
            height: auto !important;
            min-height: 200px !important;
            max-height: none !important;
            font-size: 0.9rem !important;
            flex: 1;
            resize: none;
        }
        textarea.form-control[style*="color: #999"] {
            background-color: #f8f9fa;
            border-color: #dee2e6;
        }
        .btn {
            padding: 1px 6px !important;
            font-size: 0.8rem !important;
        }
        .row {
            margin-left: 0;
            margin-right: 0;
            flex: 1;
            display: flex;
        }
        .col-md-4 {
            padding-left: 2px;
            padding-right: 2px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .col-md-8 {
            padding-left: 4px;
            padding-right: 4px;
            display: flex;
            flex-direction: column;
        }
        .email-template-section {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .email-template-section .card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .email-template-section .mb-3 {
            margin-bottom: 8px !important;
        }
        .email-template-section .mb-3:last-child {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .email-template-section .mb-3:last-child label {
            margin-bottom: 4px;
        }
        .email-template-section .mb-3:last-child textarea {
            flex: 1;
            min-height: 0;
        }
        @media (max-width: 1200px) {
            .col-md-4, .col-md-8 {
                flex: 0 0 100%;
                max-width: 100%;
            }
            .main-container {
                margin: 2px;
                height: calc(100vh - 4px);
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- App Header -->
        <div class="app-header">
            <h1><i class="fas fa-envelope-open-text"></i> Nolon Campaign</h1>
            <p class="mb-0">Professional Email Outreach Platform</p>
        </div>

        <div class="container-fluid p-4">
            <div class="row">
                <!-- Left Side: All Upload & Control Sections -->
                <div class="col-md-4">
                    <!-- CSV Upload Section -->
                    <div class="section-card upload-section">
                        <div class="section-header">
                            <i class="fas fa-users"></i> Upload Contacts (CSV)
                        </div>
                        <div class="card-body p-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="upload-area" id="csvUploadArea">
                                        <i class="fas fa-file-csv fa-lg text-primary mb-1"></i>
                                        <p class="mb-1 small">Drop your CSV file with contacts here</p>
                                        <p class="text-muted small mb-2">or click to browse</p>
                                        <input type="file" id="csvFile" accept=".csv" style="display: none;">
                                        <button class="btn btn-primary btn-sm" onclick="document.getElementById('csvFile').click()">
                                            <i class="fas fa-folder-open"></i> Choose CSV File
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div id="csvFileInfo" class="file-info-card" style="display: none;">
                                        <h6 class="mb-2">Contact Preview:</h6>
                                        <div id="csvPreviewContent" class="contact-preview"></div>
                                    </div>
                                    <div id="csvNoFile" class="text-muted text-center" style="padding: 20px;">
                                        <i class="fas fa-users fa-2x mb-2"></i>
                                        <p class="small">Upload a CSV file to see contact preview</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- DOC Upload Section -->
                    <div class="section-card template-section">
                        <div class="section-header">
                            <i class="fas fa-file-word"></i> Upload Email Template (DOC)
                        </div>
                        <div class="card-body p-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="upload-area" id="docUploadArea">
                                        <i class="fas fa-file-word fa-lg text-warning mb-1"></i>
                                        <p class="mb-1 small">Drop your DOC file with email content here</p>
                                        <p class="text-muted small mb-2">or click to browse</p>
                                        <input type="file" id="docFile" accept=".docx,.doc" style="display: none;">
                                        <button class="btn btn-warning btn-sm" onclick="document.getElementById('docFile').click()">
                                            <i class="fas fa-folder-open"></i> Choose DOC File
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div id="docFileInfo" class="file-info-card" style="display: none;">
                                        <h6 class="mb-2">Template Loaded:</h6>
                                        <div id="docPreviewContent" class="contact-preview"></div>
                                    </div>
                                    <div id="docNoFile" class="text-muted text-center" style="padding: 20px;">
                                        <i class="fas fa-file-word fa-2x mb-2"></i>
                                        <p class="small">Upload a DOC file to see template preview</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Attachment Upload Section -->
                    <div class="section-card upload-section">
                        <div class="section-header">
                            <i class="fas fa-paperclip"></i> Upload Attachments
                        </div>
                        <div class="card-body p-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="upload-area" id="attachmentUploadArea">
                                        <i class="fas fa-paperclip fa-lg text-info mb-1"></i>
                                        <p class="mb-1 small">Drop attachment files here</p>
                                        <p class="text-muted small mb-2">or click to browse</p>
                                        <input type="file" id="attachmentFile" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif,.xlsx,.xls,.zip,.rar,.7z" multiple style="display: none;">
                                        <button class="btn btn-info btn-sm" onclick="document.getElementById('attachmentFile').click()">
                                            <i class="fas fa-folder-open"></i> Choose Files
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div id="attachmentFileInfo" class="file-info-card" style="display: none;">
                                        <h6 class="mb-2">Attachments:</h6>
                                        <div id="attachmentPreviewContent" class="contact-preview"></div>
                                    </div>
                                    <div id="attachmentNoFile" class="text-muted text-center" style="padding: 20px;">
                                        <i class="fas fa-paperclip fa-2x mb-2"></i>
                                        <p class="small">Upload files to attach to emails</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Campaign Control Section -->
                    <div class="section-card control-section">
                        <div class="section-header">
                            <i class="fas fa-rocket"></i> Campaign Control
                        </div>
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center mb-3">
                                <span class="status-indicator" id="statusIndicator"></span>
                                <span id="statusText" class="fw-bold">Ready to start campaign</span>
                            </div>
                            
                            <div class="d-flex gap-3 mb-3">
                                <button class="btn btn-success btn-campaign" id="startBtn" onclick="startCampaign()">
                                    <i class="fas fa-play"></i> Start Campaign
                                </button>
                                <button class="btn btn-danger btn-campaign" id="stopBtn" onclick="stopCampaign()" style="display: none;">
                                    <i class="fas fa-stop"></i> Stop Campaign
                                </button>
                            </div>
                            
                            <!-- Progress Stats -->
                            <div class="progress-container" id="progressContainer">
                                <div class="progress mb-3" style="height: 10px; border-radius: 5px;">
                                    <div class="progress-bar bg-success" id="progressBar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="stats-card">
                                            <div class="stats-number text-success" id="sentCount">0</div>
                                            <div class="stats-label">Sent</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="stats-card">
                                            <div class="stats-number text-danger" id="failedCount">0</div>
                                            <div class="stats-label">Failed</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="stats-card">
                                            <div class="stats-number text-primary" id="totalCount">0</div>
                                            <div class="stats-label">Total</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Campaign Logs Section -->
                    <div class="section-card logs-section">
                        <div class="section-header">
                            <i class="fas fa-list"></i> Campaign Logs
                        </div>
                        <div class="card-body p-3">
                            <div class="log-container" id="logContainer">
                                <div class="text-muted text-center">No logs yet...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Side: Email Template -->
                <div class="col-md-8">
                    <!-- Email Template Section -->
                    <div class="section-card template-section email-template-section">
                        <div class="section-header">
                            <i class="fas fa-edit"></i> Email Template
                        </div>
                        <div class="card-body p-3">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Subject Line:</label>
                                <input type="text" class="form-control" id="subjectLine" placeholder="Email subject..." value="Introducing Nolon">
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Email Body:</label>
                                <textarea class="form-control" id="emailBody" rows="8" placeholder="Email content..." style="color: #999; font-style: italic;">ðŸ“‹ Instructions:

1. Drag & drop your CSV file (contacts) in the left panel
2. Drag & drop your DOC file (email template) in the left panel  
3. Edit the subject line above
4. Email body will be automatically loaded from your DOC file
5. Start the campaign when ready

Your email content will appear here after uploading a DOC file...</textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Email Preview (with images):</label>
                                <div id="emailPreview" class="border rounded p-3" style="background: white; min-height: 200px; max-height: 400px; overflow-y: auto;">
                                    <div class="text-muted text-center">
                                        <i class="fas fa-eye fa-2x mb-2"></i>
                                        <p>Email preview will appear here after uploading a DOC file</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentFile = null;
        let statusInterval = null;
        let attachmentFiles = [];
        let embeddedImages = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupFileUpload();
            setupEmailPreview();
        });

        // Setup file upload
        function setupFileUpload() {
            const csvUploadArea = document.getElementById('csvUploadArea');
            const docUploadArea = document.getElementById('docUploadArea');
            const csvFileInput = document.getElementById('csvFile');
            const docFileInput = document.getElementById('docFile');

            // CSV Drag and drop
            csvUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                csvUploadArea.classList.add('dragover');
            });

            csvUploadArea.addEventListener('dragleave', () => {
                csvUploadArea.classList.remove('dragover');
            });

            csvUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                csvUploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleCSVUpload(files[0]);
                }
            });

            // DOC Drag and drop
            docUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                docUploadArea.classList.add('dragover');
            });

            docUploadArea.addEventListener('dragleave', () => {
                docUploadArea.classList.remove('dragover');
            });

            docUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                docUploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleDOCUpload(files[0]);
                }
            });

            // Attachment Drag and drop
            const attachmentUploadArea = document.getElementById('attachmentUploadArea');
            attachmentUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                attachmentUploadArea.classList.add('dragover');
            });

            attachmentUploadArea.addEventListener('dragleave', () => {
                attachmentUploadArea.classList.remove('dragover');
            });

            attachmentUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                attachmentUploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleAttachmentUpload(files);
                }
            });

            // File input change
            csvFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleCSVUpload(e.target.files[0]);
                }
            });

            docFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleDOCUpload(e.target.files[0]);
                }
            });

            // Attachment file input
            const attachmentFileInput = document.getElementById('attachmentFile');
            attachmentFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleAttachmentUpload(e.target.files);
                }
            });
        }

        // Setup email preview updates
        function setupEmailPreview() {
            const emailBody = document.getElementById('emailBody');
            const subjectLine = document.getElementById('subjectLine');
            
            // Update preview when email body changes
            emailBody.addEventListener('input', updateEmailPreview);
            subjectLine.addEventListener('input', updateEmailPreview);
        }

        // Handle CSV file upload
        async function handleCSVUpload(file) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success && result.file_type === 'csv') {
                    currentFile = result.filename;
                    displayCSVInfo(result);
                } else {
                    alert('Error: ' + (result.error || 'Invalid file type. Please upload a CSV file.'));
                }
            } catch (error) {
                alert('Error uploading CSV file: ' + error.message);
            }
        }

        // Handle DOC file upload
        async function handleDOCUpload(file) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success && result.file_type === 'doc') {
                    displayDOCInfo(result);
                } else {
                    alert('Error: ' + (result.error || 'Invalid file type. Please upload a DOC file.'));
                }
            } catch (error) {
                alert('Error uploading DOC file: ' + error.message);
            }
        }

        // Display CSV file information
        function displayCSVInfo(data) {
            const previewContent = document.getElementById('csvPreviewContent');
            previewContent.innerHTML = '';
            
            // Handle CSV file - show contact preview
            data.preview.forEach(contact => {
                const contactDiv = document.createElement('div');
                contactDiv.className = 'border-bottom pb-2 mb-2';
                contactDiv.innerHTML = `
                    <strong>${contact.email || 'No email'}</strong><br>
                    <small class="text-muted">${contact.name || 'No name'}</small>
                `;
                previewContent.appendChild(contactDiv);
            });

            document.getElementById('csvFileInfo').style.display = 'block';
            document.getElementById('csvNoFile').style.display = 'none';
        }

        // Display DOC file information
        function displayDOCInfo(data) {
            const previewContent = document.getElementById('docPreviewContent');
            previewContent.innerHTML = '';
            
            // Handle DOC file - populate email body with plain text
            const emailBody = document.getElementById('emailBody');
            emailBody.value = data.content;
            emailBody.style.color = '#000';
            emailBody.style.fontStyle = 'normal';
            emailBody.style.backgroundColor = '#fff';
            emailBody.style.borderColor = '#ced4da';
            
            // Store HTML content for email sending
            window.docHtmlContent = data.html_content || '';
            
            // Handle embedded images
            embeddedImages = data.images || [];
            
            let imageInfo = '';
            if (embeddedImages.length > 0) {
                imageInfo = `<br><small class="text-muted">ðŸ“· ${embeddedImages.length} image(s) extracted and will be embedded in emails.</small>`;
            }
            
            previewContent.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-file-word"></i> DOC file loaded successfully!
                    <br><small class="text-muted">Email body has been updated with the content from your DOC file.</small>
                    ${imageInfo}
                </div>
            `;

            document.getElementById('docFileInfo').style.display = 'block';
            document.getElementById('docNoFile').style.display = 'none';
            
            // Update email preview with HTML content
            updateEmailPreview();
        }

        // Handle attachment upload
        async function handleAttachmentUpload(files) {
            console.log(`ðŸ” handleAttachmentUpload called with ${files.length} files:`, Array.from(files).map(f => f.name));
            
            attachmentFiles = [];
            const previewContent = document.getElementById('attachmentPreviewContent');
            previewContent.innerHTML = '';
            
            for (let file of files) {
                console.log(`ðŸ“Ž Processing attachment: ${file.name}`);
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/upload_attachment', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        attachmentFiles.push(result.filename);
                        console.log(`âœ… Attachment uploaded successfully: ${result.filename}`);
                        
                        const fileExt = result.filename.split('.').pop().toLowerCase();
                        let fileIcon = 'fas fa-file';
                        
                        // Set appropriate icon based on file type
                        if (fileExt === 'pdf') {
                            fileIcon = 'fas fa-file-pdf';
                        } else if (['doc', 'docx'].includes(fileExt)) {
                            fileIcon = 'fas fa-file-word';
                        } else if (['xls', 'xlsx'].includes(fileExt)) {
                            fileIcon = 'fas fa-file-excel';
                        } else if (['zip', 'rar', '7z'].includes(fileExt)) {
                            fileIcon = 'fas fa-file-archive';
                        } else if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExt)) {
                            fileIcon = 'fas fa-file-image';
                        } else if (fileExt === 'txt') {
                            fileIcon = 'fas fa-file-alt';
                        }
                        
                        const attachmentDiv = document.createElement('div');
                        attachmentDiv.className = 'border-bottom pb-2 mb-2';
                        attachmentDiv.innerHTML = `
                            <i class="${fileIcon}"></i> <strong>${result.filename}</strong>
                            <button class="btn btn-sm btn-outline-danger float-end" onclick="removeAttachment('${result.filename}')">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        previewContent.appendChild(attachmentDiv);
                    } else {
                        console.error(`âŒ Error uploading attachment ${file.name}:`, result.error);
                        alert('Error uploading attachment: ' + result.error);
                    }
                } catch (error) {
                    console.error(`âŒ Exception uploading attachment ${file.name}:`, error);
                    alert('Error uploading attachment: ' + error.message);
                }
            }

            console.log(`ðŸ“‹ Final attachmentFiles array:`, attachmentFiles);

            if (attachmentFiles.length > 0) {
                document.getElementById('attachmentFileInfo').style.display = 'block';
                document.getElementById('attachmentNoFile').style.display = 'none';
            }
        }

        // Remove attachment
        function removeAttachment(filename) {
            attachmentFiles = attachmentFiles.filter(file => file !== filename);
            updateAttachmentPreview();
        }

        // Update attachment preview
        function updateAttachmentPreview() {
            const previewContent = document.getElementById('attachmentPreviewContent');
            previewContent.innerHTML = '';
            
            attachmentFiles.forEach(filename => {
                const fileExt = filename.split('.').pop().toLowerCase();
                let fileIcon = 'fas fa-file';
                
                // Set appropriate icon based on file type
                if (fileExt === 'pdf') {
                    fileIcon = 'fas fa-file-pdf';
                } else if (['doc', 'docx'].includes(fileExt)) {
                    fileIcon = 'fas fa-file-word';
                } else if (['xls', 'xlsx'].includes(fileExt)) {
                    fileIcon = 'fas fa-file-excel';
                } else if (['zip', 'rar', '7z'].includes(fileExt)) {
                    fileIcon = 'fas fa-file-archive';
                } else if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExt)) {
                    fileIcon = 'fas fa-file-image';
                } else if (fileExt === 'txt') {
                    fileIcon = 'fas fa-file-alt';
                }
                
                const attachmentDiv = document.createElement('div');
                attachmentDiv.className = 'border-bottom pb-2 mb-2';
                attachmentDiv.innerHTML = `
                    <i class="${fileIcon}"></i> <strong>${filename}</strong>
                    <button class="btn btn-sm btn-outline-danger float-end" onclick="removeAttachment('${filename}')">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                previewContent.appendChild(attachmentDiv);
            });

            if (attachmentFiles.length > 0) {
                document.getElementById('attachmentFileInfo').style.display = 'block';
                document.getElementById('attachmentNoFile').style.display = 'none';
            } else {
                document.getElementById('attachmentFileInfo').style.display = 'none';
                document.getElementById('attachmentNoFile').style.display = 'block';
            }
        }

        // Update email preview with HTML and images
        function updateEmailPreview() {
            const emailPreview = document.getElementById('emailPreview');
            const emailBody = document.getElementById('emailBody').value;
            
            if (!emailBody || emailBody.includes('ðŸ“‹ Instructions:')) {
                emailPreview.innerHTML = `
                    <div class="text-muted text-center">
                        <i class="fas fa-eye fa-2x mb-2"></i>
                        <p>Email preview will appear here after uploading a DOC file</p>
                    </div>
                `;
                return;
            }
            
            // Check if we have HTML content from DOC file
            if (window.docHtmlContent && window.docHtmlContent.trim()) {
                // Use the HTML content from DOC file for preview
                let htmlContent = window.docHtmlContent;
                
                // Add embedded images info if available
                if (embeddedImages && embeddedImages.length > 0) {
                    htmlContent += '<div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; background: #f8f9fa; padding: 15px; border-radius: 5px;">';
                    htmlContent += '<h6 style="color: #666; margin-bottom: 10px;">ðŸ“· Embedded Images:</h6>';
                    
                    embeddedImages.forEach((imagePath, index) => {
                        const imageName = imagePath.split('/').pop();
                        htmlContent += `
                            <div style="margin: 5px 0; padding: 8px; background: #fff; border-radius: 3px; border: 1px solid #ddd;">
                                <strong>Image ${index + 1}:</strong> ${imageName}
                                <br><small style="color: #666;">This image will be embedded in the email body</small>
                            </div>
                        `;
                    });
                    
                    htmlContent += '</div>';
                }
                
                emailPreview.innerHTML = htmlContent;
            } else {
                // Fallback to plain text with basic formatting
                let htmlContent = `
                    <div style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
                        ${emailBody.replace(/\n/g, '<br>')}
                `;
                
                // Add embedded images if available
                if (embeddedImages && embeddedImages.length > 0) {
                    htmlContent += '<div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">';
                    htmlContent += '<h6 style="color: #666; margin-bottom: 10px;">ðŸ“· Embedded Images:</h6>';
                    
                    embeddedImages.forEach((imagePath, index) => {
                        const imageName = imagePath.split('/').pop();
                        htmlContent += `
                            <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                <strong>Image ${index + 1}:</strong> ${imageName}
                                <br><small style="color: #666;">This image will be embedded in the email body</small>
                            </div>
                        `;
                    });
                    
                    htmlContent += '</div>';
                }
                
                htmlContent += '</div>';
                
                emailPreview.innerHTML = htmlContent;
            }
        }



        // Start campaign
        async function startCampaign() {
            if (!currentFile) {
                alert('Please upload a CSV file first');
                return;
            }

            const customSubject = document.getElementById('subjectLine').value;
            const customBody = document.getElementById('emailBody').value;

            if (!customSubject || !customBody) {
                alert('Please fill in both subject and body');
                return;
            }

            // Debug: Log what we're sending
            console.log('ðŸš€ Starting campaign with:');
            console.log('- CSV file:', currentFile);
            console.log('- Attachments array:', attachmentFiles);
            console.log('- Attachments count:', attachmentFiles.length);
            console.log('- Embedded images:', embeddedImages);
            console.log('- Subject:', customSubject);
            console.log('- Body length:', customBody.length);
            console.log('- HTML content length:', window.docHtmlContent ? window.docHtmlContent.length : 0);

            // Create the payload
            const payload = {
                filename: currentFile,
                custom_subject: customSubject,
                custom_body: customBody,
                attachments: attachmentFiles,
                embedded_images: embeddedImages,
                html_content: window.docHtmlContent || ''
            };

            console.log('ðŸ“¤ Sending payload to backend:', payload);

            try {
                const response = await fetch('/start_campaign', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    updateStatus('running');
                    startStatusPolling();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error starting campaign: ' + error.message);
            }
        }

        // Stop campaign
        async function stopCampaign() {
            try {
                const response = await fetch('/stop_campaign', {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    updateStatus('stopped');
                    stopStatusPolling();
                }
            } catch (error) {
                console.error('Error stopping campaign:', error);
            }
        }

        // Update status
        function updateStatus(status) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const progressContainer = document.getElementById('progressContainer');

            indicator.className = 'status-indicator';
            
            switch (status) {
                case 'running':
                    indicator.classList.add('status-running');
                    text.textContent = 'Campaign running...';
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-block';
                    progressContainer.style.display = 'block';
                    break;
                case 'stopped':
                    indicator.classList.add('status-stopped');
                    text.textContent = 'Campaign stopped';
                    startBtn.style.display = 'inline-block';
                    stopBtn.style.display = 'none';
                    break;
                default:
                    indicator.classList.add('status-idle');
                    text.textContent = 'Ready to start campaign';
                    startBtn.style.display = 'inline-block';
                    stopBtn.style.display = 'none';
                    progressContainer.style.display = 'none';
            }
        }

        // Start status polling
        function startStatusPolling() {
            statusInterval = setInterval(pollStatus, 1000);
        }

        // Stop status polling
        function stopStatusPolling() {
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
        }

        // Poll status
        async function pollStatus() {
            try {
                const response = await fetch('/status');
                const status = await response.json();
                
                // Update progress
                document.getElementById('progressBar').style.width = status.progress + '%';
                document.getElementById('sentCount').textContent = status.sent;
                document.getElementById('failedCount').textContent = status.failed;
                document.getElementById('totalCount').textContent = status.total;
                
                // Update status
                if (status.running) {
                    updateStatus('running');
                } else {
                    updateStatus('stopped');
                    stopStatusPolling();
                }
                
                // Update logs
                updateLogs();
                
            } catch (error) {
                console.error('Error polling status:', error);
            }
        }

        // Update logs
        async function updateLogs() {
            try {
                const response = await fetch('/logs');
                const data = await response.json();
                
                const logContainer = document.getElementById('logContainer');
                logContainer.innerHTML = '';
                
                data.logs.forEach(log => {
                    const logEntry = document.createElement('div');
                    logEntry.className = `log-entry log-${log.level}`;
                    logEntry.innerHTML = `<small>[${log.timestamp}]</small> ${log.message}`;
                    logContainer.appendChild(logEntry);
                });
                
                // Scroll to bottom
                logContainer.scrollTop = logContainer.scrollHeight;
                
            } catch (error) {
                console.error('Error updating logs:', error);
            }
        }
    </script>
</body>
</html> 